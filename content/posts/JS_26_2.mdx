---
title: ì½”ë“œìŠ¤í”¼ì¸ 85 2íšŒ-(2) ë™ì‹œì„± ëª¨ë¸ì„ ì§ì ‘ êµ¬í˜„í•˜ë©° ì´í•´í•˜ê¸°.
date: '2019-11-11'
description: "ì½”ë“œìŠ¤í”¼ì¸  85ì—ì„œëŠ” none blockingì— ëŒ€í•œ ì´ì•¼ê¸°ì™€ ìë°”ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì§œëŠ” ê·¼ë³¸ì ì¸ ë°©ë²•ì— ëŒ€í•œ ê³ ì°°ì„ ì´ì•¼ê¸°í•´ë³¸ë‹¤. --- \U0001F315\U0001F311\U0001F311 TL;DR setTimerì—ì„œë¶€í„° promiseê¹Œì§€ ë™ì‹œì„± ëª¨ë¸ì„ ê¸°ë°˜ìœ¼ë¡œ êµ¬í˜„í•˜ë©°, ë£¨í”„ ì œì–´ê¶Œì˜ í†µì œì— ëŒ€í•˜ì—¬ ì•Œì•„ë³¸ë‹¤...."
author: Joy Kim
tags:
  - javaScript
  - codeSpitz
categories:
  - 01_Web
  - zz. Workshop
enableComment: true
customList: |-
  [
    {
      "title": {
        "name": "setTimer",
        "sub": "setTimerë¥¼ êµ¬í˜„í•˜ì—¬ ë™ì‹œì„±ëª¨ë¸ ì´í•´",
        "id": "setTimer",
        "style": {
          "type": "number",
          "index": "1"
        }
      }
    },
    {
      "title": {
        "name": "Non Blocking For",
        "sub": "Non Blockingì²˜ëŸ¼ For êµ¬í˜„í•´ë³´ê¸°",
        "id": "nbFor",
        "style": {
          "type": "number",
          "index": "2"
        }
      }
    },
    {
      "title": {
        "name": "Generator",
        "sub": "Non Blockingì²˜ëŸ¼ For êµ¬í˜„í•´ë³´ê¸°",
        "id": "generator",
        "style": {
          "type": "number",
          "index": "3"
        }
      }
    },
    {
      "title": {
        "name": "Promise",
        "sub": "ë¹„ë™ê¸° ë°˜ì œì–´",
        "id": "promise",
        "style": {
          "type": "number",
          "index": "4"
        }
      }
    }
  ]
thumbnail: /images/2019/37/thumb_default.jpg
---

ì½”ë“œìŠ¤í”¼ì¸  85ì—ì„œëŠ” `none blocking`ì— ëŒ€í•œ ì´ì•¼ê¸°ì™€ ìë°”ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì§œëŠ” ê·¼ë³¸ì ì¸ ë°©ë²•ì— ëŒ€í•œ ê³ ì°°ì„
ì´ì•¼ê¸°í•´ë³¸ë‹¤.

---

ğŸŒ•ğŸŒ‘ğŸŒ‘

## TL;DR

setTimerì—ì„œë¶€í„° promiseê¹Œì§€ ë™ì‹œì„± ëª¨ë¸ì„ ê¸°ë°˜ìœ¼ë¡œ êµ¬í˜„í•˜ë©°, ë£¨í”„ ì œì–´ê¶Œì˜ í†µì œì— ëŒ€í•˜ì—¬ ì•Œì•„ë³¸ë‹¤.

---



## 1. setTimerë¥¼ êµ¬í˜„í•´ë³´ê¸°

### entity

1. Item

- ì‹¤í–‰ë  ì‹œê°„ê³¼ ì‹¤í–‰í•  ì‹œê°„ì„ ê°–ê³  ìˆëŠ” ê°ì²´

2. queue

- callback queue ì—­í• ì„ í•˜ëŠ” í
- ê°ì²´ ë¦¬ìŠ¤íŠ¸ í˜•íƒœì¸ Setìœ¼ë¡œ ìƒì„±

```ts
const Item = class {
  time: number; // ëª‡ì´ˆ í›„ì— ì‹¤í–‰í• ì§€
  block: Function; // ëª‡ì´ˆ í›„ì— ì‹¤í–‰í•  í•¨ìˆ˜
  constructor(block, time) {
    this.block = block;
    this.time = time + performance.now();
  }
};

const queue = new Set();
```

<details>
  <summary>cf__1. performace, Set, value</summary>
  <ul>
    <li>
      <code>performance.now()</code>
      <ul>
        <li>ë¸Œë¼ìš°ì €ê°€ ì‹¤í–‰ë˜ ì´í›„ì— ì§€ë‚œ ì‹œê°„</li>
        <li>date.now()ë³´ë‹¤ ì¢‹ì€ ì ì€ ë‚˜ë…¸ì´ˆê¹Œì§€ ë³¼ ìˆ˜ ìˆë‹¤.</li>
      </ul>
    </li>
    <li>
      <code>Set</code>
      <ul>
        <li>ë°°ì—´ì— ë‹´ì„ ìˆ˜ ìˆëŠ”ê±´ ê°’ë§Œ ë‹´ì„ ìˆ˜ ìˆë‹¤.</li>
        <li>ê°™ì€ ê°ì²´ê°€ ì¤‘ë³µìœ¼ë¡œ ë“¤ì–´ê°€ì§€ ì•ŠëŠ”ë‹¤.</li>
        <li>ê°ì²´ë¥¼ ë‹´ëŠ” ë¦¬ìŠ¤íŠ¸</li>
      </ul>
    </li>
    <li>
      <code>value</code>
      <ul>
        <li>ë¶ˆë³€</li>
        <li>ìì²´ì˜ ê°’ìœ¼ë¡œ íŒë‹¨í•œë‹¤.</li>
        <li>ê°’ìœ¼ë¡œ ì‹ë³„ëœë‹¤.</li>
      </ul>
    </li>
  </ul>
</details>

---

### Core Action

1. callback íë¥¼ ì§€ì†ì ìœ¼ë¡œ ì²´í¬í•œë‹¤.

- íì— í˜¸ì¶œì‹œê°„ë³´ë‹¤ ì‘ìœ¼ë©´ ì‹¤í–‰í•˜ì§€ ì•ŠëŠ”ë‹¤.
- íì— í˜¸ì¶œì‹œê°„ë³´ë‹¤ í¬ë©´
  1. ì‹¤í–‰í•˜ê³ 
  2. ì‚­ì œí•œë‹¤.

```ts
@params time í˜„ì¬ì‹œê°„
const checkQueue = (time: number) => {
  queue.forEach((item: {time: number, block: Function}) => {
    if(item.time > time) return; // í˜„ì¬ì‹œê°„ì´ í˜¸ì¶œì‹œê°„ë³´ë‹¤ ì‘ë‹¤ë©´ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ.
    else { // í˜„ì¬ì‹œê°„ì´ í˜¸ì¶œì‹œê°„ë³´ë‹¤ ì‘ë‹¤ë©´ ì‹¤í–‰.
      queue.delete(item); // ì‹¤í–‰í•  ì˜ˆì •ì´ê¸°ë•Œë¬¸ì— ì‚­ì œ
      item.block(); // ì‹¤í–‰
    }
  });
  requestAnimationFrame(checkQueue);
}
requestAnimationFrame(checkQueue);
```

> **cf\_\_2 `requestAnimationFrame`**

- ë¸Œë¼ìš°ì €ì—ê²Œ ìˆ˜í–‰í•˜ê¸°ë¥¼ ì›í•˜ëŠ” ì• ë‹ˆë©”ì´ì…˜ì„ ì•Œë¦¬ê³ , ë‹¤ìŒ ë¦¬í˜ì¸íŠ¸ê°€ ì§„í–‰ë˜ê¸° ì „ì— í•´ë‹¹
  ì• ë‹ˆë©”ì´ì…˜ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê²Œ í•œë‹¤.
- ë¦¬í˜ì¸íŠ¸ ì´ì „ì— ì‹¤í–‰í•  ì½œë°±ì„ ì¸ìë¡œ ë°›ëŠ”ë‹¤.
- ì—”ì§„ì´ ë Œë”ë§ì´ ëë‚˜ë©´ ì§ì ‘ ë°œìƒì‹œí‚¤ëŠ” í•¨ìˆ˜

---

#### íŠ¸ë¦¬ê±°

```ts
const timeout = (block: Funtion, time: number) => queue.add(new Item(block, time));
```

---

#### í™•ì¸í•´ë³´ì.

```ts
timeout(_ => console.log('hello'), 1000);
```

### ì •ë¦¬

**ë°©ê¸ˆ êµ¬í˜„í•œ setTimerë¥¼ ë™ì‹œì„± ëª¨ë¸ë¡œ êµ¬í˜„í•´ë³´ë©´?**

<img src="/images/2019/37/01.jpg" style={{width: '100%'}} />

**ì¢€ë” í° ê·¸ë¦¼ì—ì„œ ë³´ë©´?**

<img src="/images/2019/37/02.jpg" style={{width: '100%'}} />

- ë™ì‹œì„±ì„ ë§Œë“¤ì–´ë‚´ëŠ” ì´ë²¤íŠ¸ ë£¨í”„ ì•ˆì— ì‘ì€ ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ ë§Œë“¤ì–´ë‚¸ ê²ƒ.

---

---



## 2. Non Blocking For êµ¬í˜„í•´ë³´ê¸°

```ts
const working = _ => {};
for(let i=0; i < 100000; i++) working();

@params max ìµœëŒ€ ë£¨í”„ìˆ˜
@params load í•œë²ˆì— ë¡œë“œí•  ì¹´ìš´íŠ¸
@params block ì‹¤í–‰í•  í•¨ìˆ˜
const nbFor = (max:number, load: number, block: Function) => {
  let i = 0;


  const f = (time:number) => {
    let curr = load;
    // í•œë²ˆì— ë¡œë“œí•  ì¹´ìš´íŠ¸ë¥¼ ìƒíƒœë¡œ ë°›ê¸° ìœ„í•´ ë³€ìˆ˜ì— í• ë‹¹
    while(curr-- && i < max) {
      // 1. 1íšŒëŒë•Œë§ˆë‹¤ í˜„ì¬ ìƒíƒœë¥¼ í•˜ë‚˜ì”© ëº€ë‹¤.
      block();
      // 2. ì‹¤í–‰
      i++;
    }
    console.log(i);
    if(i < max-1) requestAnimationFrame(f)
  }


  requestAnimationFrame(f); // --- (1)
}
```

1. `requestAnimationFrame`ìœ¼ë¡œ ë‚´ë¶€í•¨ìˆ˜ `f`ê°€ ì‹¤í–‰
2. loadê¸°ì¤€ìœ¼ë¡œ ë°˜ë³µ ì¹´ìš´íŠ¸ê°€ chunkëœë‹¤.
3. whileë¬¸ì´ í•œ ì…‹íŠ¸ê°€(load ì¹´ìš´íŠ¸ê°€ ì¢…ë£Œ) ëë‚˜ë©´, `requestAnimationFrame`ìœ¼ë¡œ `f`í•¨ìˆ˜ë¥¼ ë‹¤ì‹œ
   ì‹¤í–‰ì‹œí‚¨ë‹¤.

- í•˜ë‚˜ì˜ í”„ë ˆì„ì´ ëë‚˜ë©´ ì œì–´ê¶Œì„ ë‹¤ì‹œ ì—”ì§„ì—ê²Œ ëŒë ¤ì¤€ë‹¤.

4. ë‹¤ì‹œ
5. maxê¹Œì§€ ë£¨í”„ê°€ ëë‚˜ë©´ ë”ì´ìƒ fë¥¼ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ.

- í•˜ë‚˜ì˜ í”„ë ˆì„ì´ ëë‚˜ë©´ ì œì–´ê¶Œì„ ë‹¤ì‹œ ì—”ì§„ì—ê²Œ ëŒë ¤ì¤€ë‹¤.
- í´ë¡œì € íŒ¨í„´ì´ ì¡´ì¬, iê°€ ìƒíƒœë¥¼ ë¬¼ê³  ìˆìŒ

---

---



## 3. Generator êµ¬í˜„í•´ë³´ê¸°

- [ì œë„ˆë ˆì´í„° ê¸€ì°¸ê³ ](https://feel5ny.github.io/2019/02/03/JS_19/)

```ts
const infinity: Iterator = (function* () {
  let i = 0;
  while (true) yield i++;
})();
console.log(infinity.next());
```

```ts
// lib.es2015.iterable.d.ts
interface IteratorResult<T> {
  done: boolean;
  value: T;
}

interface Iterator<T> {
  next(value?: any): IteratorResult<T>;
  return?(value?: any): IteratorResult<T>;
  throw?(e?: any): IteratorResult<T>;
}
```

- ì œë„ˆë ˆì´í„°ëŠ” **ìœ ì‚¬ iterable**ì´ë‹¤.
  - ì œë„ˆë ˆì´í„° ìì²´ëŠ” iterableì´ ì•„ë‹ˆë‹¤.
  - iterableì€ iteratorë¼ëŠ” í•¨ìˆ˜(`[Symbol.iterator]()`)ë¥¼ í˜¸ì¶œí•˜ë©´ iterator ê°ì²´ë¥¼ ì£¼ëŠ”ë°,
    generatorë¥¼ í˜¸ì¶œí•˜ë©´ iteratorê°€ ë°˜í™˜ëœë‹¤.
  - generatorëŠ” `for...of`ë¥¼ ì‚¬ìš©í•˜ì§€ ëª»í•œë‹¤. for...ofëŠ” iterableì´ ì™€ì•¼í•˜ê¸° ë•Œë¬¸ì—
- `yield`ê°€ ì¼ì–´ë‚  ë•Œë§ˆë‹¤ `next`ë¡œ ë‹¤ìŒ í„´ì„ ì¤„ ìˆ˜ ìˆë‹¤.

---

### `function*`

- ë‚´ë¶€ì ìœ¼ë¡œ **suspend** êµ¬ê°„ì„ ìƒì„±í•œë‹¤.
  - ë™ê¸°ëª…ë ¹ì€ ì ˆëŒ€ë¡œ ë©ˆì¶œ ìˆ˜ ì—†ë‹¤.
    - generatorëŠ” ë©ˆì¶œ ìˆ˜ ìˆë‹¤.
    - generatorëŠ” ì¤‘ê°„ì— ëŠì„ ìˆ˜ ìˆë‹¤.
- **yieldë¥¼ í˜¸ì¶œí•˜ë©´ suspendê°€ ì¼ì–´ë‚œë‹¤.**
  - ë©ˆì¶˜ë‹¤.
  - ë‹¤ìŒë²ˆ next í˜¸ì¶œì‹œ ë‚´ë¶€ì ìœ¼ë¡œ ë‹¤ì‹œ ì¬ê°œë˜ì–´ì„œ ë£¨í”„ëˆë‹¤.
    - next í˜¸ì¶œí• ë•Œë§ˆë‹¤ `suspend`ê°€ ì¼ì–´ë‚œ ê³³ì—ì„œ `resume`ì´ ì¼ì–´ë‚œë‹¤.
    - ë©ˆì¶”ëŠ” ê²ƒ: `suspend`
    - ë‹¤ì‹œ ì¬ê°œ: `resume`

```ts
const gene = function* (max: number, load: number, block: Function) {
  let i = 0,
    curr = load;
  while (i < max) {
    if (curr--) {
      block();
      i++;
    } else {
      curr = load; // currì„ ì´ˆê¸°í™”í•˜ê³ 
      console.log(i);
      yield; // ì œì–´ê¶Œì„ ë°–ì— ë‘”ë‹¤.
    }
  }
};
```

- suspendë¡œ ë©ˆì¶°ì„œ ì œì–´ê¶Œì„ ì™¸ë¶€ì— ìœ„ì„í•  ìˆ˜ ìˆë‹¤.
- `gene.next()`

```ts
const nbFor = (max, load, block) => {
  const iterator: Iterator = gene(max, load, block);
  const f = _ => iterator.next().done || timeout(f);
  timeout(f); // timeoutì„ ì“°ëŠ” ìœ„ì¹˜ë¥¼ ë°–ìœ¼ë¡œ ì˜®ê²¼ë‹¤.
};
```

**ì œì–´ ì‹œìŠ¤í…œì˜ ë°˜ì œì–´ê¶Œì„ ì™¸ë¶€ì— ì¤Œìœ¼ë¡œì¨** ë‚´ë¶€ì—ì„œ ì œì–´ì™€ ê´€ë ¨ëœ ë¡œì§ì„ ë¶„ë¦¬ì‹œí‚¬ìˆ˜ ìˆê²Œ ëœë‹¤ëŠ”ê²Œ
ì œë„ˆë ˆì´í„°ì˜ ì¥ì 

---

---



## 4. Promise êµ¬í˜„í•´ë³´ê¸°

- ë¹„ë™ê¸° ë°˜ì œì–´

1. íŠ¸ë¦¬ê±°ë¥¼ ê±¸ì—ˆìŒ
2. ì„œë²„ê°€ 3ì´ˆë§Œì— ë°ì´í„°ë¥¼ ì¤¬ìŒ
3. 3ì´ˆ ì•ˆì—ëŠ” ì œì–´í•  ê¶Œí•œì´ ì—†ìŒ
4. 3ì´ˆ ì´í›„ì—ëŠ” ì œì–´í•  ê¶Œí•œì´ ìˆìŒ

- Promiseì— ë°”ë¡œ `then`ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ë°˜ì œì–´ê¶Œì´ ì´ì ì„ í™œìš©í•˜ì§€ ì•Šê³  **ì½œë°±ì²˜ëŸ¼ ì“°ëŠ” í˜•íƒœ**
- ë‚´ê°€ ì›í• ë•Œ thenì„ í˜¸ì¶œí•  ìˆ˜ ìˆë‹¤.

```ts
const gene2 = function* (max, load, block) {
  let i = 0;
  while (i < max) {
    yield new Promise(res => {
      let curr = load;
      while (curr-- && i < max) {
        block();
        i++;
      }
      console.log(i);
      timeout(res, 0);
    });
  }
};
```

- yieldë¥¼ ë³´ë‚¼ë•Œ Promiseë¡œ ê°ì‹¸ì„œ ë³´ë‚´ê³  ìˆë‹¤.
- ì œì–´ê¶Œì„ ì™„ì „ ì–‘ë„í–ˆì—ˆì§€ë§Œ ìœ„ ì½”ë“œëŠ” capsulizingí•´ì„œ Promiseì•ˆì˜ ì‘ì—…ì´ ëë‚˜ë©´ thenì„ í˜¸ì¶œí•  ìˆ˜
  ìˆê²Œë” ë°˜ì œì–´ê¶Œì„ ì£¼ì—ˆìŒ.

```ts
const nbFor = (max, load, block) => {
  const iterator: Iterator<Promise> = gene2(max, load, block);
  const next = ({ value, done }) => dome || value.then(v => next(iterator.next()));
  next(iterator.next());
};
```

- nbForì—ì„œëŠ” íŠ¸ë¦¬ê±° ì—­í• ë§Œí•˜ëŠ” ê²ƒì´ê³ ,
- ì œì–´ëŠ” Promiseê°€ í•œë‹¤.
- coí•¨ìˆ˜, redux-saga, ...

---

## ì°¸ê³ ìë£Œ

- [requestAnimationFrame](https://developers.google.com/web/fundamentals/performance/rendering/optimize-javascript-execution?hl=ko)
